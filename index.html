<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Mina SQLite Database Viewer ("NO LONGER WORKS MIGRATED TO POSTGRESSQL")</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #0d47a1;
            --secondary: #1565c0;
            --success: #2e7d32;
            --danger: #c62828;
            --warning: #f57c00;
            --info: #0277bd;
            --purple: #6a1b9a;
        }
        
        body {
            background: linear-gradient(135deg, #0d47a1 0%, #1565c0 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .dashboard-container {
            background: white;
            border-radius: 25px;
            box-shadow: 0 35px 70px rgba(0,0,0,0.5);
            overflow: hidden;
        }
        
        .navbar-custom {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 25px 40px;
            color: white;
            border-bottom: 3px solid rgba(255,255,255,0.1);
        }
        
        .navbar-brand {
            color: white;
            font-weight: 800;
            font-size: 1.8rem;
        }
        
        .navbar-subtitle {
            color: rgba(255,255,255,0.9);
            font-size: 1rem;
            margin-left: 10px;
        }
        
        .status-badge {
            background: rgba(255,255,255,0.25);
            padding: 12px 24px;
            border-radius: 30px;
            color: white;
            font-size: 1rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .main-content {
            padding: 40px;
        }
        
        /* Stats Cards */
        .stat-card {
            background: linear-gradient(145deg, #ffffff, #f0f4f8);
            border: none;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 6px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary), var(--secondary));
        }
        
        .stat-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        
        .stat-icon {
            width: 70px;
            height: 70px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin-bottom: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 8px 20px rgba(13, 71, 161, 0.3);
        }
        
        .stat-number {
            font-size: 3rem;
            font-weight: 800;
            color: var(--primary);
            line-height: 1;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-label {
            color: #666;
            font-size: 1rem;
            margin-top: 10px;
            font-weight: 500;
        }
        
        /* Search Container */
        .search-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            border: 1px solid #eef2f7;
        }
        
        .search-box {
            border: 2px solid #e3e8f0;
            border-radius: 15px;
            padding: 18px 25px;
            font-size: 1.1rem;
            transition: all 0.3s;
            background: #f8fafc;
        }
        
        .search-box:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(13, 71, 161, 0.15);
            background: white;
            transform: translateY(-2px);
        }
        
        /* Database Explorer */
        .db-explorer {
            background: white;
            border-radius: 20px;
            padding: 0;
            margin-bottom: 40px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            overflow: hidden;
            border: 1px solid #eef2f7;
        }
        
        .explorer-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 25px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .explorer-title {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .explorer-actions {
            display: flex;
            gap: 12px;
        }
        
        .action-btn {
            padding: 12px 25px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .btn-primary-custom {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .btn-primary-custom:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        /* Tables Grid */
        .tables-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 25px;
        }
        
        .table-card {
            background: white;
            border: 1px solid #e3e8f0;
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .table-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 25px rgba(13, 71, 161, 0.15);
        }
        
        .table-card.active {
            border-color: var(--primary);
            background: #f0f7ff;
        }
        
        .table-card-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-bottom: 20px;
        }
        
        .table-name {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.2rem;
            margin-bottom: 8px;
        }
        
        .table-description {
            color: #666;
            font-size: 0.95rem;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .table-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        
        .table-row-count {
            background: #e8eaf6;
            color: var(--primary);
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        /* Data Table */
        .data-table-container {
            padding: 30px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .data-table th {
            background: #f5f7fa;
            color: var(--primary);
            font-weight: 700;
            padding: 20px 15px;
            border-bottom: 3px solid #e8eaf6;
            position: sticky;
            top: 0;
            z-index: 10;
            text-align: left;
            font-size: 1rem;
        }
        
        .data-table td {
            padding: 18px 15px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: top;
            font-size: 0.95rem;
        }
        
        .data-table tr:hover {
            background: #f8f9ff;
        }
        
        /* JSON Viewer */
        .json-viewer {
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 12px;
            padding: 25px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.6;
        }
        
        .json-key { color: #9cdcfe; }
        .json-string { color: #ce9178; }
        .json-number { color: #b5cea8; }
        .json-boolean { color: #569cd6; }
        .json-null { color: #569cd6; }
        
        /* Modal */
        .modal-xl-custom {
            max-width: 95%;
        }
        
        .modal-header-custom {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 25px 30px;
            border-radius: 0;
        }
        
        /* Footer */
        .footer {
            background: #f5f7fa;
            padding: 25px 40px;
            border-top: 1px solid #e8eaf6;
            color: #666;
            font-size: 0.9rem;
        }
        
        /* Loading */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 20px;
            z-index: 1000;
        }
        
        .loading-spinner {
            text-align: center;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #e8eaf6;
            border-top: 6px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Badges */
        .badge-custom {
            padding: 8px 16px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .badge-patient { background: #e3f2fd; color: var(--primary); }
        .badge-doctor { background: #e8f5e9; color: var(--success); }
        .badge-admin { background: #fce4ec; color: var(--danger); }
        .badge-active { background: #e8f5e9; color: var(--success); }
        .badge-inactive { background: #ffebee; color: var(--danger); }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .navbar-custom {
                padding: 20px;
            }
            
            .stat-number {
                font-size: 2.5rem;
            }
            
            .tables-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Table type colors */
        .table-type-user { border-left: 4px solid var(--primary); }
        .table-type-medical { border-left: 4px solid var(--success); }
        .table-type-appointment { border-left: 4px solid var(--info); }
        .table-type-chat { border-left: 4px solid var(--purple); }
        .table-type-ml { border-left: 4px solid var(--warning); }
        .table-type-system { border-left: 4px solid #666; }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <nav class="navbar-custom">
            <div class="container-fluid">
                <div class="d-flex flex-column">
                    <div class="navbar-brand">
                        <i class="fas fa-database me-3"></i>
                       MINA SQLite Database Viewer
                    </div>
                    <div class="navbar-subtitle">
                        Real-time MINA Database
                    </div>
                </div>
                <div class="d-flex align-items-center gap-4">
                    <div class="status-badge">
                        <i class="fas fa-circle text-success me-2"></i>
                        <span id="statusText">Connecting...</span>
                    </div>
                    <button class="btn btn-light refresh-btn" onclick="loadDatabase()" style="padding: 12px 25px; border-radius: 12px;">
                        <i class="fas fa-sync-alt me-2"></i>Refresh All
                    </button>
                </div>
            </div>
        </nav>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Statistics -->
            <div class="row mb-5" id="statsSection">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-number" id="totalUsers">0</div>
                        <div class="stat-label">Total Users</div>
                        <div class="stat-trend">
                            <i class="fas fa-database me-2"></i>
                            <span id="userRoles">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-table"></i>
                        </div>
                        <div class="stat-number" id="totalTables">0</div>
                        <div class="stat-label">Database Tables</div>
                        <div class="stat-trend">
                            <i class="fas fa-server me-2"></i>
                            <span id="databaseType">SQLite</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="stat-number" id="appointmentCount">0</div>
                        <div class="stat-label">Appointments</div>
                        <div class="stat-trend">
                            <i class="fas fa-stethoscope me-2"></i>
                            <span id="appointmentStatus">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-file-medical"></i>
                        </div>
                        <div class="stat-number" id="totalRecords">0</div>
                        <div class="stat-label">Medical Records</div>
                        <div class="stat-trend">
                            <i class="fas fa-clipboard-list me-2"></i>
                            <span id="recordTypes">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="search-container">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="input-group">
                            <span class="input-group-text bg-primary text-white border-0" style="border-radius: 15px 0 0 15px;">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control search-box border-0" id="searchInput" 
                                   placeholder="Search across all tables (users, emails, symptoms...)">
                            <button class="btn btn-primary border-0" onclick="searchDatabase()" 
                                    style="border-radius: 0 15px 15px 0; padding: 18px 30px;">
                                Search
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="btn-group">
                            <button class="action-btn btn-primary-custom" onclick="testDatabaseConnection()">
                                <i class="fas fa-plug me-2"></i>Test Connection
                            </button>
                            <button class="action-btn btn-primary-custom" onclick="showDatabaseInfo()">
                                <i class="fas fa-info-circle me-2"></i>DB Info
                            </button>
                            <button class="action-btn btn-primary-custom" onclick="exportDatabase()">
                                <i class="fas fa-download me-2"></i>Export Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Database Explorer -->
            <div class="db-explorer">
                <div class="explorer-header">
                    <div class="explorer-title">
                        <i class="fas fa-project-diagram"></i>
                        Database Tables Explorer
                        <span class="badge bg-light text-primary ms-2" id="selectedTableInfo">Click any table to view data</span>
                    </div>
                    <div class="explorer-actions">
                        <button class="action-btn btn-primary-custom" onclick="loadDatabase()">
                            <i class="fas fa-redo"></i> Refresh
                        </button>
                        <button class="action-btn btn-primary-custom" onclick="showQueryEditor()">
                            <i class="fas fa-code"></i> SQL Editor
                        </button>
                    </div>
                </div>
                
                <!-- Tables Grid -->
                <div id="tablesGrid" class="tables-grid">
                    <div class="text-center py-5 col-span-3">
                        <div class="spinner"></div>
                        <h4 class="text-muted mt-3">Loading database tables...</h4>
                    </div>
                </div>
                
                <!-- Table Data -->
                <div id="tableDataSection" style="display: none;">
                    <div class="data-table-container" id="tableDataContainer">
                        <!-- Table data will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div>
                        <i class="fas fa-server me-2"></i>
                        <strong>Database:</strong> telemedicine_dev.db ‚Ä¢ SQLite
                        <span class="ms-3">
                            <i class="fas fa-clock me-1"></i>
                            Last updated: <span id="lastUpdated" class="fw-bold">Never</span>
                        </span>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <div class="text-muted">
                        <i class="fas fa-shield-alt me-1"></i>
                        Read-only interface ‚Ä¢ Backend: 
                        <span class="fw-bold" id="backendUrl">mina-backend-1.onrender.com</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Database Info Modal -->
    <div class="modal fade" id="databaseModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl-custom">
            <div class="modal-content">
                <div class="modal-header modal-header-custom">
                    <h5 class="modal-title">
                        <i class="fas fa-info-circle me-2"></i>
                        Database Information
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="databaseInfoContent">
                        Loading database information...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Query Editor Modal -->
    <div class="modal fade" id="queryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl-custom">
            <div class="modal-content">
                <div class="modal-header modal-header-custom">
                    <h5 class="modal-title">
                        <i class="fas fa-code me-2"></i>
                        SQL Query Editor
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <textarea class="form-control" id="sqlQuery" rows="5" 
                                  placeholder="Enter SQL query (e.g., SELECT * FROM users WHERE role = 'patient')">
SELECT * FROM users ORDER BY created_at DESC LIMIT 10
                        </textarea>
                    </div>
                    <div class="d-flex gap-2 mb-4">
                        <button class="btn btn-primary" onclick="executeQuery()">
                            <i class="fas fa-play me-2"></i>Execute Query
                        </button>
                        <button class="btn btn-secondary" onclick="clearQuery()">
                            <i class="fas fa-broom me-2"></i>Clear
                        </button>
                        <button class="btn btn-info" onclick="loadSampleQueries()">
                            <i class="fas fa-lightbulb me-2"></i>Sample Queries
                        </button>
                    </div>
                    <div id="queryResults" class="json-viewer">
                        Query results will appear here...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const BACKEND_URL = 'https://mina-backend-1.onrender.com';
        let currentSelectedTable = null;
        let databaseStats = null;
        let allTables = [];
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDatabase();
            document.getElementById('backendUrl').textContent = BACKEND_URL.replace('https://', '');
        });
        
        // Load database info and tables
        async function loadDatabase() {
            showLoading(true);
            try {
                // Load database stats
                const statsResponse = await fetch(`${BACKEND_URL}/sql-database-stats`);
                databaseStats = await statsResponse.json();
                
                // Load tables
                const tablesResponse = await fetch(`${BACKEND_URL}/sql-tables`);
                const tablesData = await tablesResponse.json();
                
                allTables = tablesData.tables || [];
                
                updateStatus('Connected', 'success');
                updateStatistics(databaseStats);
                displayTablesGrid(allTables);
                updateTimestamp();
                
                // Auto-select first table if none selected
                if (!currentSelectedTable && allTables.length > 0) {
                    loadTableData(allTables[0]);
                }
                
            } catch (error) {
                console.error('Error:', error);
                updateStatus('Connection Failed', 'danger');
                showError(`Failed to load database: ${error.message}`);
            }
            showLoading(false);
        }
        
        // Update statistics display
        function updateStats(stats) {
            if (!stats || stats.error) return;
            
            document.getElementById('totalUsers').textContent = 
                stats.statistics?.users?.by_role ? 
                Object.values(stats.statistics.users.by_role).reduce((a, b) => a + b, 0) : 
                0;
            
            document.getElementById('totalTables').textContent = stats.statistics?.total_tables || 0;
            
            document.getElementById('appointmentCount').textContent = 
                stats.statistics?.appointments?.by_status ?
                Object.values(stats.statistics.appointments.by_status).reduce((a, b) => a + b, 0) :
                0;
            
            document.getElementById('totalRecords').textContent = 
                stats.statistics?.table_row_counts?.medical_records || 0;
            
            // Update user roles
            if (stats.statistics?.users?.by_role) {
                const roles = Object.entries(stats.statistics.users.by_role)
                    .map(([role, count]) => `${role}: ${count}`)
                    .join(', ');
                document.getElementById('userRoles').textContent = roles;
            }
            
            // Update appointment status
            if (stats.statistics?.appointments?.by_status) {
                const statuses = Object.entries(stats.statistics.appointments.by_status)
                    .map(([status, count]) => `${status}: ${count}`)
                    .join(', ');
                document.getElementById('appointmentStatus').textContent = statuses;
            }
        }
        
        // Display tables as cards in a grid
        function displayTablesGrid(tables) {
            const tablesGrid = document.getElementById('tablesGrid');
            
            if (!tables || tables.length === 0) {
                tablesGrid.innerHTML = `
                    <div class="col-span-3">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            No tables found in database
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            tables.forEach(table => {
                const rowCount = databaseStats?.statistics?.table_row_counts?.[table] || '?';
                const description = getTableDescription(table);
                const tableType = getTableType(table);
                const icon = getTableIcon(table);
                
                html += `
                    <div class="table-card ${currentSelectedTable === table ? 'active' : ''} table-type-${tableType}" 
                         onclick="loadTableData('${table}')">
                        <div class="table-card-icon">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div class="table-name">${table}</div>
                        <div class="table-description">${description}</div>
                        <div class="table-meta">
                            <span class="table-row-count">${rowCount} rows</span>
                            <button class="btn btn-sm btn-outline-primary" 
                                    onclick="event.stopPropagation(); viewTableSchema('${table}')"
                                    title="View Schema">
                                <i class="fas fa-info"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            tablesGrid.innerHTML = html;
        }
        
        // Load data for a specific table
        async function loadTableData(tableName) {
            currentSelectedTable = tableName;
            
            // Update UI
            document.querySelectorAll('.table-card').forEach(card => {
                card.classList.remove('active');
                if (card.querySelector('.table-name').textContent === tableName) {
                    card.classList.add('active');
                }
            });
            
            document.getElementById('selectedTableInfo').textContent = `${tableName} table`;
            document.getElementById('tableDataSection').style.display = 'block';
            
            try {
                const response = await fetch(`${BACKEND_URL}/sql-table/${tableName}`);
                const data = await response.json();
                
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                displayTableData(data);
                
            } catch (error) {
                showError(`Failed to load table: ${error.message}`);
            }
        }
        
        // Display table data
        function displayTableData(tableData) {
            const container = document.getElementById('tableDataContainer');
            
            if (!tableData.data || tableData.data.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-database fa-4x text-muted mb-4"></i>
                        <h4 class="text-muted">Table: ${tableData.table}</h4>
                        <p class="text-muted">This table is empty (0 rows)</p>
                        <div class="mt-4">
                            <small class="text-muted">Columns: ${tableData.columns?.join(', ') || 'N/A'}</small>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Create table HTML
            let html = `
                <div class="mb-4">
                    <h4 class="text-primary">
                        <i class="fas fa-table me-2"></i>${tableData.table}
                        <span class="badge bg-primary ms-2">${tableData.row_count} total rows</span>
                        <span class="badge bg-info ms-2">${tableData.display_count} displayed</span>
                    </h4>
                    <p class="text-muted">
                        <i class="fas fa-columns me-1"></i>
                        Columns: ${tableData.columns?.length || 0}
                        <button class="btn btn-sm btn-link" onclick="exportTable('${tableData.table}')">
                            <i class="fas fa-download me-1"></i>Export
                        </button>
                    </p>
                </div>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                ${tableData.columns.map(col => `<th>${formatColumnName(col)}</th>`).join('')}
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Add rows
            tableData.data.forEach((row, rowIndex) => {
                html += `<tr>`;
                
                tableData.columns.forEach(col => {
                    const value = row[col];
                    html += `<td>${formatCellValue(value)}</td>`;
                });
                
                // Add action buttons
                html += `
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" 
                                    onclick="viewRowDetails('${tableData.table}', ${rowIndex}, ${JSON.stringify(row).replace(/'/g, "\\'")})" 
                                    title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-secondary" 
                                    onclick="copyRowData(${JSON.stringify(row).replace(/'/g, "\\'")})" 
                                    title="Copy Row">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                html += `</tr>`;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // Update statistics on the page
        function updateStatistics(data) {
            updateStats(data);
        }
        
        // Search database
        async function searchDatabase() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (!searchTerm) {
                alert('Please enter a search term');
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/sql-search/${encodeURIComponent(searchTerm)}`);
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                if (data.total_matches === 0) {
                    alert(`No results found for "${searchTerm}"`);
                    return;
                }
                
                // Display results in modal
                let resultsHtml = `
                    <h5>Search Results for "${searchTerm}"</h5>
                    <p class="text-muted mb-4">
                        Found ${data.total_matches} matches in ${data.tables_with_matches} tables
                    </p>
                `;
                
                data.results.forEach(result => {
                    resultsHtml += `
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-table me-2"></i>${result.table}
                                    <span class="badge bg-primary ms-2">${result.match_count} matches</span>
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                ${Object.keys(result.matches[0] || {}).map(col => 
                                                    `<th>${formatColumnName(col)}</th>`
                                                ).join('')}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${result.matches.map(row => `
                                                <tr>
                                                    ${Object.values(row).map(val => 
                                                        `<td>${formatCellValue(val, 50)}</td>`
                                                    ).join('')}
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('databaseInfoContent').innerHTML = resultsHtml;
                const modal = new bootstrap.Modal(document.getElementById('databaseModal'));
                modal.show();
                
            } catch (error) {
                alert(`Search error: ${error.message}`);
            }
        }
        
        // Test database connection
        async function testDatabaseConnection() {
            try {
                const response = await fetch(`${BACKEND_URL}/sql-test-connection`);
                const data = await response.json();
                
                let infoHtml = `
                    <div class="alert alert-${data.status === 'connected' ? 'success' : 'danger'}">
                        <i class="fas fa-${data.status === 'connected' ? 'check-circle' : 'times-circle'} me-2"></i>
                        Database Status: <strong>${data.status.toUpperCase()}</strong>
                    </div>
                `;
                
                if (data.status === 'connected') {
                    infoHtml += `
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-body">
                                        <h6 class="card-title text-primary">
                                            <i class="fas fa-database me-2"></i>Database Information
                                        </h6>
                                        <ul class="list-unstyled">
                                            <li class="mb-2"><strong>Type:</strong> ${data.database?.type || 'SQLite'}</li>
                                            <li class="mb-2"><strong>Version:</strong> ${data.database?.version || 'N/A'}</li>
                                            <li class="mb-2"><strong>Tables:</strong> ${data.database?.tables_count || 0}</li>
                                            <li class="mb-2"><strong>File:</strong> telemedicine_dev.db</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title text-primary">
                                            <i class="fas fa-plug me-2"></i>Available Endpoints
                                        </h6>
                                        <ul class="list-unstyled">
                                            ${(data.endpoints_available || []).map(endpoint => 
                                                `<li class="mb-1"><code>${endpoint}</code></li>`
                                            ).join('')}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    infoHtml += `
                        <div class="alert alert-warning">
                            <strong>Error:</strong> ${data.error || 'Unknown error'}
                        </div>
                    `;
                }
                
                document.getElementById('databaseInfoContent').innerHTML = infoHtml;
                const modal = new bootstrap.Modal(document.getElementById('databaseModal'));
                modal.show();
                
            } catch (error) {
                alert(`Connection test failed: ${error.message}`);
            }
        }
        
        // Show database info
        async function showDatabaseInfo() {
            try {
                const response = await fetch(`${BACKEND_URL}/sql-database-info`);
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                let infoHtml = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">
                                        <i class="fas fa-database me-2"></i>Database Overview
                                    </h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><strong>Type:</strong> ${data.database?.type || 'SQLite'}</li>
                                        <li class="mb-2"><strong>Filename:</strong> ${data.database?.filename || 'telemedicine_dev.db'}</li>
                                        <li class="mb-2"><strong>Tables:</strong> ${data.database?.tables_count || 0}</li>
                                        <li class="mb-2"><strong>Total Rows:</strong> ${data.database?.total_rows || 0}</li>
                                        <li class="mb-2"><strong>Size:</strong> ${data.database?.estimated_size || 'N/A'}</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">
                                        <i class="fas fa-table me-2"></i>Tables Summary
                                    </h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Table</th>
                                                    <th>Rows</th>
                                                    <th>Columns</th>
                                                    <th>Type</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${(data.table_details || []).map(table => `
                                                    <tr>
                                                        <td>
                                                            <a href="#" onclick="loadTableData('${table.name}'); return false;">
                                                                ${table.name}
                                                            </a>
                                                        </td>
                                                        <td>${table.row_count || 0}</td>
                                                        <td>${table.column_count || 0}</td>
                                                        <td><span class="badge bg-secondary">${getTableType(table.name)}</span></td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('databaseInfoContent').innerHTML = infoHtml;
                const modal = new bootstrap.Modal(document.getElementById('databaseModal'));
                modal.show();
                
            } catch (error) {
                alert(`Error loading database info: ${error.message}`);
            }
        }
        
        // Export database
        async function exportDatabase() {
            try {
                const response = await fetch(`${BACKEND_URL}/sql-export`);
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                // Create download link
                const dataStr = JSON.stringify(data, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                const exportFileDefaultName = `telemedicine-db-export-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                alert(`‚úÖ Database exported to ${exportFileDefaultName}`);
                
            } catch (error) {
                alert(`Export error: ${error.message}`);
            }
        }
        
        // Export specific table
        async function exportTable(tableName) {
            try {
                const response = await fetch(`${BACKEND_URL}/sql-export/${tableName}?format=json`);
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                // Create download link
                const dataStr = JSON.stringify(data, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                const exportFileDefaultName = `${tableName}-export-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                alert(`‚úÖ Table ${tableName} exported to ${exportFileDefaultName}`);
                
            } catch (error) {
                alert(`Export error: ${error.message}`);
            }
        }
        
        // Show query editor
        function showQueryEditor() {
            const modal = new bootstrap.Modal(document.getElementById('queryModal'));
            modal.show();
        }
        
        // Execute SQL query
        async function executeQuery() {
            const query = document.getElementById('sqlQuery').value.trim();
            if (!query) {
                alert('Please enter a SQL query');
                return;
            }
            
            try {
                const resultsDiv = document.getElementById('queryResults');
                resultsDiv.innerHTML = '<div class="text-center py-3"><div class="spinner"></div><p>Executing query...</p></div>';
                
                const response = await fetch(`${BACKEND_URL}/sql-query?query=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.error) {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Query Error: ${data.error}
                        </div>
                    `;
                    return;
                }
                
                // Display results
                if (data.data && data.data.length > 0) {
                    let html = `
                        <div class="mb-3">
                            <h6>Query Results (${data.row_count} rows)</h6>
                            <small class="text-muted">Query: ${data.query}</small>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-dark table-sm">
                                <thead>
                                    <tr>
                                        ${data.columns.map(col => `<th>${col}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.data.map(row => `
                                        <tr>
                                            ${data.columns.map(col => `<td>${formatCellValue(row[col])}</td>`).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    if (data.truncated) {
                        html += `<p class="text-muted">Showing first ${data.data.length} of ${data.row_count} rows</p>`;
                    }
                    resultsDiv.innerHTML = html;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Query executed successfully. Rows affected: ${data.rows_affected || 0}
                        </div>
                    `;
                }
                
            } catch (error) {
                document.getElementById('queryResults').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Query Error: ${error.message}
                    </div>
                `;
            }
        }
        
        // Load sample queries
        function loadSampleQueries() {
            const samples = [
                "SELECT * FROM users LIMIT 10",
                "SELECT role, COUNT(*) as count FROM users GROUP BY role",
                "SELECT * FROM appointments WHERE status = 'scheduled'",
                "SELECT full_name, email, role FROM users WHERE is_active = 1",
                "SELECT * FROM symptom_conditions ORDER BY urgency_level DESC",
                "SELECT patient_id, COUNT(*) as appointment_count FROM appointments GROUP BY patient_id",
                "SELECT * FROM medical_records ORDER BY record_date DESC LIMIT 5",
                "SELECT medication_name, COUNT(*) as prescription_count FROM prescriptions GROUP BY medication_name"
            ];
            
            const randomQuery = samples[Math.floor(Math.random() * samples.length)];
            document.getElementById('sqlQuery').value = randomQuery;
        }
        
        // View table schema
        async function viewTableSchema(tableName) {
            try {
                const response = await fetch(`${BACKEND_URL}/sql-table-schema/${tableName}`);
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                let schemaHtml = `
                    <h5>Table Schema: ${tableName}</h5>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <h6><i class="fas fa-columns me-2"></i>Columns (${data.columns.length})</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Type</th>
                                            <th>Nullable</th>
                                            <th>Primary Key</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.columns.map(col => `
                                            <tr>
                                                <td><code>${col.name}</code></td>
                                                <td><span class="badge bg-secondary">${col.type}</span></td>
                                                <td>${col.nullable ? 'Yes' : 'No'}</td>
                                                <td>${col.primary_key ? '‚úì' : ''}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6><i class="fas fa-key me-2"></i>Relationships</h6>
                `;
                
                if (data.primary_keys.length > 0) {
                    schemaHtml += `
                        <p><strong>Primary Keys:</strong> ${data.primary_keys.join(', ')}</p>
                    `;
                }
                
                if (data.foreign_keys.length > 0) {
                    schemaHtml += `
                        <p><strong>Foreign Keys:</strong></p>
                        <ul>
                            ${data.foreign_keys.map(fk => `
                                <li>${fk.constrained_columns.join(', ')} ‚Üí ${fk.referred_table}(${fk.referred_columns.join(', ')})</li>
                            `).join('')}
                        </ul>
                    `;
                }
                
                if (data.indexes.length > 0) {
                    schemaHtml += `
                        <p><strong>Indexes:</strong></p>
                        <ul>
                            ${data.indexes.map(idx => `
                                <li><code>${idx.name}</code> on (${idx.columns.join(', ')}) ${idx.unique ? '[UNIQUE]' : ''}</li>
                            `).join('')}
                        </ul>
                    `;
                }
                
                schemaHtml += `</div></div>`;
                
                document.getElementById('databaseInfoContent').innerHTML = schemaHtml;
                const modal = new bootstrap.Modal(document.getElementById('databaseModal'));
                modal.show();
                
            } catch (error) {
                alert(`Error loading schema: ${error.message}`);
            }
        }
        
        // View row details
        function viewRowDetails(table, rowIndex, rowData) {
            const row = typeof rowData === 'string' ? JSON.parse(rowData) : rowData;
            const details = `
                <h5>Row Details: ${table}</h5>
                <p class="text-muted">Row Index: ${rowIndex + 1}</p>
                <div class="json-viewer">${syntaxHighlight(JSON.stringify(row, null, 2))}</div>
            `;
            document.getElementById('databaseInfoContent').innerHTML = details;
            const modal = new bootstrap.Modal(document.getElementById('databaseModal'));
            modal.show();
        }
        
        // Copy row data
        function copyRowData(rowData) {
            const row = typeof rowData === 'string' ? JSON.parse(rowData) : rowData;
            navigator.clipboard.writeText(JSON.stringify(row, null, 2))
                .then(() => alert('‚úÖ Row data copied to clipboard!'))
                .catch(err => alert('‚ùå Failed to copy: ' + err));
        }
        
        // Utility functions
        function formatColumnName(col) {
            return col.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }
        
        function formatCellValue(value, maxLength = 100) {
            if (value === null || value === undefined) return '<span class="text-muted fst-italic">null</span>';
            if (typeof value === 'boolean') return value ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-secondary">No</span>';
            if (Array.isArray(value)) return `<span class="badge bg-info">Array[${value.length}]</span>`;
            if (typeof value === 'object') return `<span class="badge bg-warning">Object</span>`;
            if (typeof value === 'string') {
                if (value.startsWith('{') && value.endsWith('}')) {
                    try {
                        const obj = JSON.parse(value);
                        return `<span class="badge bg-info">JSON (${Object.keys(obj).length} keys)</span>`;
                    } catch {
                        // Not valid JSON, continue
                    }
                }
                if (value.length > maxLength) return value.substring(0, maxLength) + '...';
            }
            return value;
        }
        
        function getTableDescription(table) {
            const descriptions = {
                'users': 'User accounts with roles (patient, doctor, admin)',
                'appointments': 'Medical appointments and consultations',
                'medical_records': 'Patient medical history and records',
                'prescriptions': 'Medication prescriptions',
                'notifications': 'System notifications for users',
                'chat_messages': 'Real-time chat messages between users',
                'symptom_conditions': 'Medical conditions for AI symptom checker',
                'symptom_checker_sessions': 'AI symptom checker sessions and results',
                'ml_models': 'Machine learning models and versions'
            };
            return descriptions[table] || 'Database table with structured data';
        }
        
        function getTableType(table) {
            if (table.includes('user')) return 'user';
            if (table.includes('appointment')) return 'appointment';
            if (table.includes('record') || table.includes('prescription')) return 'medical';
            if (table.includes('chat') || table.includes('message')) return 'chat';
            if (table.includes('symptom') || table.includes('ml')) return 'ml';
            if (table.includes('notification')) return 'system';
            return 'system';
        }
        
        function getTableIcon(table) {
            const icons = {
                'users': 'fa-users',
                'appointments': 'fa-calendar-check',
                'medical_records': 'fa-file-medical',
                'prescriptions': 'fa-prescription',
                'notifications': 'fa-bell',
                'chat_messages': 'fa-comments',
                'symptom_conditions': 'fa-stethoscope',
                'symptom_checker_sessions': 'fa-robot',
                'ml_models': 'fa-brain'
            };
            return icons[table] || 'fa-table';
        }
        
        function syntaxHighlight(json) {
            if (!json) return '';
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, 
            function (match) {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }
        
        function updateStatus(text, type) {
            const statusEl = document.getElementById('statusText');
            statusEl.textContent = text;
            const badge = statusEl.closest('.status-badge');
            badge.style.background = type === 'success' ? 
                'rgba(46, 125, 50, 0.25)' : 'rgba(198, 40, 40, 0.25)';
        }
        
        function updateTimestamp() {
            const now = new Date();
            document.getElementById('lastUpdated').textContent = 
                now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
        }
        
        function showLoading(show) {
            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.id = 'loadingOverlay';
            overlay.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p class="mt-3">Loading database...</p>
                </div>
            `;
            
            if (show) {
                document.querySelector('.main-content').style.position = 'relative';
                const existing = document.getElementById('loadingOverlay');
                if (!existing) {
                    document.querySelector('.main-content').appendChild(overlay);
                }
            } else {
                const existing = document.getElementById('loadingOverlay');
                if (existing) existing.remove();
            }
        }
        
        function showError(message) {
            const alertHtml = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert" 
                     style="position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', alertHtml);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                const alert = document.querySelector('.alert-danger');
                if (alert) alert.remove();
            }, 5000);
        }
        
        function clearQuery() {
            document.getElementById('sqlQuery').value = '';
        }
    </script>
</body>

</html>
